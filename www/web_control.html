<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROS Robot Control Interface</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    #joystick-container {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        text-align: center;
    }
    #joystick {
        width: 100%;
        max-width: 200px;
        height: auto;
    }
</style>
</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4">ROS Robot Control Interface</h1>

    <!-- <img id="camera-stream" src="" width="640" height="480"> -->
    <script>
      document.write("<img src='http://210.156.173.178:8080/stream?topic=/image_raw&type=ros_compressed'></img>");
    </script>
    <div id="joystick-container">
        <div class="form-group">
            <label for="linear-velocity">Linear Velocity (x-axis): </label>
            <input type="range" class="custom-range" min="-1" max="1" step="0.1" id="linear-velocity" value="0">
            <span id="linear-velocity-value">0</span>
          </div>
        <div class="form-group">
            <label for="angular-velocity">Angular Velocity (z-axis): </label>
            <input type="range" class="custom-range" min="-1" max="1" step="0.1" id="angular-velocity" value="0">
            <span id="angular-velocity-value">0</span>
          </div>
        <div class="form-group">
          <label for="max-velocity">Max Velocity: </label>
          <input type="range" class="custom-range" min="0.0" max="1.0" step="0.01" id="max-velocity" value="0">
          <span id="max-velocity-value">0</span>
        </div>
        <canvas id="joystick" width="200" height="200"></canvas>
        <button type="button" id="move-button" class="btn btn-primary btn-block mt-2">Move Robot</button>
        <button type="button" id="stop-button" class="btn btn-danger btn-block mt-2">Emergency Stop</button>
    </div>
</div>
<script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script src="./roslib.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>



    var joystick = document.getElementById('joystick');
    var ctx = joystick.getContext('2d');
    var joystickRadius = 80;
    var joystickCenterX = joystick.width / 2;
    var joystickCenterY = joystick.height / 2;
    var isDragging = false;
    var ros = new ROSLIB.Ros();
    ros.connect('ws://210.156.173.178:9090');

    var cmd_vel = new ROSLIB.Topic({
      ros: ros,
      name: '/cmd_vel',
      messageType: 'geometry_msgs/Twist'
    });
    var imageTopic = new ROSLIB.Topic({
      ros: ros,
      name: '/usb_cam/image_raw',
      messageType: 'sensor_msgs/Image'
    });
    imageTopic.subscribe(function(message) {
      var imgData = "data:image/jpeg;base64," + message.data;
      console.log(imgData);
      document.getElementById('camera-stream').src = imgData;
    });
    function publishTwist(linearVel, angularVel) {
      var twist = new ROSLIB.Message({
        linear: {
          x: linearVel,
          y: 0.0,
          z: 0.0
        },
        angular: {
          x: 0.0,
          y: 0.0,
          z: -angularVel
        }
      });

      cmd_vel.publish(twist);
      console.log("Publishing cmd_vel: linear x = " + linearVel + ", angular z = " + angularVel);
    }

    function drawJoystick(x, y) {
        ctx.clearRect(0, 0, joystick.width, joystick.height);

        ctx.beginPath();
        ctx.arc(joystickCenterX, joystickCenterY, joystickRadius, 0, Math.PI * 2);
        ctx.fillStyle = 'lightgray';
        ctx.fill();
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.closePath();

        ctx.beginPath();
        ctx.arc(x, y, 20, 0, Math.PI * 2);
        ctx.fillStyle = 'gray';
        ctx.fill();
        ctx.closePath();
        var Vel = parseFloat($("#max-velocity").val());
        console.log((x-100.0)/80.0,-(y-100.0)/80.0)
        publishTwist(-Vel*(y-100.0)/80.0,0.6*(x-100.0)/80.0)
    }

    function handleTouchStart(e) {
        e.preventDefault();
        var touch = e.touches[0];
        var rect = joystick.getBoundingClientRect();
        var touchX = touch.clientX - rect.left;
        var touchY = touch.clientY - rect.top;

        var distance = Math.sqrt((touchX - joystickCenterX) ** 2 + (touchY - joystickCenterY) ** 2);
        if (distance <= joystickRadius) {
            isDragging = true;
            drawJoystick(touchX, touchY);
        }
    }

    function handleTouchMove(e) {
        e.preventDefault();
        if (isDragging) {
            var touch = e.touches[0];
            var rect = joystick.getBoundingClientRect();
            var touchX = touch.clientX - rect.left;
            var touchY = touch.clientY - rect.top;

            var distance = Math.sqrt((touchX - joystickCenterX) ** 2 + (touchY - joystickCenterY) ** 2);
            if (distance <= joystickRadius) {
                drawJoystick(touchX, touchY);
            } else {
                var angle = Math.atan2(touchY - joystickCenterY, touchX - joystickCenterX);
                var newX = joystickCenterX + joystickRadius * Math.cos(angle);
                var newY = joystickCenterY + joystickRadius * Math.sin(angle);
                drawJoystick(newX, newY);
            }
        }
    }

    function handleTouchEnd(e) {
        e.preventDefault();
        isDragging = false;
        drawJoystick(joystickCenterX, joystickCenterY);
    }
    $('#linear-velocity').on('input', function() {
      $('#linear-velocity-value').text($(this).val());
  });

  $('#angular-velocity').on('input', function() {
      $('#angular-velocity-value').text($(this).val());
  });

  $('#max-velocity').on('input', function() {
      $('#max-velocity-value').text($(this).val());
  });

  var timeoutID;

  function resetPublishTimer() {
      if (timeoutID) {
          clearTimeout(timeoutID);
      }
      timeoutID = setTimeout(function () {
          publishTwist(0, 0);
          console.log("No new commands received. Emergency Stop Activated!");
      }, 1000); // Adjust the time here (in milliseconds) as needed
  }

  ros.on('connection', function() {
      console.log('Connected to ROS');
      resetPublishTimer();
  });

  ros.on('close', function() {
      console.log('Disconnected from ROS');
      if (timeoutID) {
          clearTimeout(timeoutID);
      }
  });

  ros.on('error', function(error) {
      console.log('Error connecting to ROS: ', error);
      if (timeoutID) {
          clearTimeout(timeoutID);
      }
  });
    drawJoystick(joystickCenterX, joystickCenterY);
    joystick.addEventListener('touchstart', handleTouchStart);
    joystick.addEventListener('touchmove', handleTouchMove);
    joystick.addEventListener('touchend', handleTouchEnd);
    joystick.addEventListener('touchcancel', handleTouchEnd);

    $("#move-button").click(function() {
      var linearVel = parseFloat($("#linear-velocity").val());
      var angularVel = parseFloat($("#angular-velocity").val());
      publishTwist(linearVel, angularVel);
      resetPublishTimer();
    });

    $("#stop-button").click(function() {
      publishTwist(0, 0);
      console.log("Emergency Stop Activated!");
      if (timeoutID) {
            clearTimeout(timeoutID);
        }
    });

    
  </script>
</body>
</html>
